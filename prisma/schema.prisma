generator client {
  provider = "prisma-client-js"
}

// prisma/schema.prisma

datasource db {
  provider  = "postgresql"
  // Pooled connection for your running app (goes through PgBouncer on port 6543)
  url       = env("DATABASE_URL")
  // Direct connection for migrations & prisma studio (5432)
  directUrl = env("DATABASE_DIRECT_URL")
}

enum Role {
  USER
  ADMIN
}

enum AuditAction {
  USER_CREATED
  SUBSCRIPTION_TOGGLED
  FILE_UPLOADED
  FILE_ASSIGNED
  APIKEY_CREATED
  APIKEY_REVOKED
  DOWNLOAD_GRANTED
  SUPPORT_TICKET
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum BusinessType {
  RESTAURANT_GRILL // 1 Εστιατόριο - Ψητοπωλείο
  RESTAURANT_GRILL_HYGIENE_WITH_COFFEE // <-- ΝΕΟ
  BAR_WINE // 2a Bar – Wine Bar
  REFRESHMENT_CAFE // 2b Αναψυκτήριο – καφετέρια
  SCHOOL_KIOSK // 2c Σχολικό κυλικείο
  PASTRY_SHOP_WITH_COFFEE // 3a Πρατήριο ζαχ/κής με παροχή καφέ
  PASTRY_SHOP_NO_COFFEE // 3b Πρατήριο ζαχ/κής χωρίς παροχή καφέ
  BREAD_SHOP_WITH_COFFEE // 4 Πρατήριο άρτου με παροχή καφέ
  BUTCHER // 5a Κρεοπωλείο
  BUTCHER_HOT_CORNER // 5b Κρεοπωλείο με ζεστή γωνιά
  FISHMONGER // 6a Ιχθυοπωλείο
  FISHMONGER_HOT_CORNER // 6b Ιχθυοπωλείο με ζεστή γωνιά
  DELI_CHEESE_CURED_MEAT // 7 Διάθεση προϊόντων αλλαντοποιίας/Τυροκομίας
  BAKERY_WITH_COFFEE // 8a Αρτοποιείο με παροχή καφέ
  BAKERY_NO_COFFEE // 8b Αρτοποιείο χωρίς παροχή καφέ
  BAKERY_PASTRY_WITH_COFFEE // 8γ Αρτοποιείο – Ζαχαροπλαστείο με παροχή καφέ
  PASTRY_WITH_COFFEE // 8δ Ζαχαροπλαστείο με παροχή καφέ
  PASTRY_NO_COFFEE // 8ε Ζαχαροπλαστείο χωρίς παροχή καφέ
  GROCERY_FRUIT // 9 Παντοπωλείο / οπωροπωλείο
  WINE_NUTS_SHOP // 10 Κάβα / κατάστημα ξηρών καρπών
  FROZEN_PRODUCTS_SHOP // 11 Πρατήριο κατεψυγμένων προϊόντων
  PACKAGED_FRESH_FROZEN_DRY // 12 Συσκευασμένα προϊόντα νωπά/κατεψυγμένα/ξηρού φορτίου
  ICE_CREAM_SHOP // 13 Παγωτοπωλείο
  PUFF_PASTRY_PRODUCTION // 14 Παρασκευή – πώληση σφολιατοειδών προϊόντων
}

enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PublicHoliday {
  NEW_YEAR // 01/01
  THEOPHANY_JAN_6
  CLEAN_MONDAY // Καθαρά Δευτέρα
  MARCH_25 // 25/03
  EASTER_SUNDAY
  EASTER_MONDAY
  AUG_15 // Κοίμηση Θεοτόκου
  OCT_28 // 28/10
  CHRISTMAS // 25/12
  BOXING_DAY // 26/12
}

model User {
  id                 String        @id @default(cuid())
  name               String
  email              String        @unique
  passwordHash       String
  role               Role          @default(USER)
  subscriptionActive Boolean       @default(false)
  status             AccountStatus @default(PENDING)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  uploads             File[]               @relation("UserUploads")
  assignments         FileAssignment[]     @relation("UserAssignments")
  assignmentsGiven    FileAssignment[]     @relation("AssignmentsAssignedBy")
  auditLogs           AuditLog[]           @relation("AuditActor")
  passwordResetTokens PasswordResetToken[]

  profile UserProfile? // <-- add this back-relation
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Επωνυμία
  businessName String

  // Business types (enum, πολλά)
  businessTypes BusinessType[]

  // Πλήθος εξοπλισμού συντήρησης
  fridgeCount          Int @default(0) // Αριθμός ψυγείων
  freezerCount         Int @default(0) // Αριθμός καταψύξεων
  hotCabinetCount      Int @default(0) // Αριθμός θερμοθαλάμων / Bain Marie
  dryAgedChamberCount  Int @default(0) // Αριθμός θαλάμων Dry Aged
  iceCreamFreezerCount Int @default(0) // Αριθμός καταψύκτη/έκθεσης παγωτών

  // Αρχικά υπευθύνου
  supervisorInitials String?

  // Μέρες εβδομάδας που είναι κλειστά
  closedWeekdays Weekday[] // MONDAY...SUNDAY

  // Σταθερές αργίες που είναι κλειστά
  closedHolidays PublicHoliday[]

  // Διάστημα Αυγούστου που είναι κλειστά (ημερομηνίες με year)
  augustClosedFrom DateTime?
  augustClosedTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordResetToken {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([expiresAt])
}

model File {
  id           String   @id @default(cuid())
  title        String
  originalName String?
  url          String? // for external or pre-signed location (we’ll wire actual uploads next day)
  mime         String?
  size         Int?
  uploadedBy   User?    @relation("UserUploads", fields: [uploadedById], references: [id])
  uploadedById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Assignments
  assignments FileAssignment[]

  @@index([uploadedById])
  @@index([createdAt])
}

model FileAssignment {
  id           String   @id @default(cuid())
  file         File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId       String
  user         User     @relation("UserAssignments", fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  assignedBy   User     @relation("AssignmentsAssignedBy", fields: [assignedById], references: [id])
  assignedById String
  note         String?
  createdAt    DateTime @default(now())

  @@unique([fileId, userId]) // prevent double-assigning the same file to same user
  @@index([userId, createdAt])
  @@index([assignedById])
}

model ApiKey {
  id         String    @id @default(cuid())
  label      String
  keyHash    String
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
}

model AuditLog {
  id        String      @id @default(cuid())
  actorId   String?
  actor     User?       @relation("AuditActor", fields: [actorId], references: [id])
  action    AuditAction
  targetId  String?
  target    String?
  meta      Json?
  createdAt DateTime    @default(now())

  @@index([actorId]) // optional
}
